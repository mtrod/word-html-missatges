<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">
  <title>Word-a-HTML</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/dracula.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.2/mammoth.browser.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="assets/js/finalHtmlTemplate.js"></script>
  <script src="assets/js/urls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/css/css.min.js"></script>
  <!-- Include jQuery and jQuery UI for autocomplete on the analytics fields -->
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <style></style>
</head>
<body>
  <div class="container-fluid mb-4 border-bottom border-black" style="background: #38ff90;">
    <div class="container">
      <h6 class="pb-2 pt-3 font-monospace fw-bold">Conversor Word-a-HTML</h6>
    </div>
  </div>
  <div class="container">
    <!-- File input and title -->
    <div class="row mb-4">
      <div class="col">
        <input class="form-control rounded-0 border font-monospace" type="file" id="fileInput" accept=".doc,.docx">
      </div>
      <div class="col">
        <input class="form-control rounded-0 border font-monospace" type="text" id="titleInput" placeholder="Títol del missatge">
      </div>
    </div>
    <!-- Editor and HTML output in two fixed columns -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="editor" class="form-label fw-bold font-monospace">Previsualització</label>
        <div class="preview-editor p-2 bg-white border">
          <div id="toolbar" class="border mb-2">
            <!-- Standard Quill buttons -->
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <!--<button class="ql-underline"></button>-->
            <select class="ql-header">
              <option value="1">Header 1</option>
              <option value="2">Header 2</option>
              <option value="">Normal</option>
            </select>
            <select class="ql-color">
              <option value="#000078">Blau UOC</option>
              <option value="#73EDFF">Cian UOC</option>
              <option value="#D5FAFF">Cian clar</option>
              <option value="#ffffff">Blanc</option>
              <option value="#000000">Negre</option>
              <option value="red">Vermell</option>
            </select>
            <button class="ql-list" value="ordered" style="color: blue;"></button>
            <button class="ql-list" value="bullet"></button>
            <button class="ql-clean"></button>
            <button class="ql-link"></button>
            <button class="ql-image-url" title="URL imatge">
              <svg viewBox="0 0 18 18">
                <rect class="ql-stroke" height="10" width="12" x="3" y="4"></rect>
                <circle class="ql-fill" cx="6" cy="7" r="1"></circle>
                <polyline class="ql-even ql-fill" points="5 12 5 11 7 9 8 10 11 7 13 9 13 12 5 12"></polyline>
              </svg>
            </button>
            <button id="youtubeButton" title="Youtube">
              <svg viewBox="0 0 18 18">
                <rect class="ql-stroke" height="12" width="12" x="3" y="3"></rect>
                <rect class="ql-fill" height="12" width="1" x="5" y="3"></rect>
                <rect class="ql-fill" height="12" width="1" x="12" y="3"></rect>
                <rect class="ql-fill" height="2" width="8" x="5" y="8"></rect>
              </svg>
            </button>
            <button id="customCodeButton" style="width: 34px;cursor: pointer;" title="Botó">
              <svg viewBox="-3 0 24 18" style="background: #444;border: 2px solid white;">
                <polyline class="ql-stroke" style="stroke:#fff;" points="5.5 13 9 5 12.5 13"></polyline>
                <line class="ql-stroke" x1="11.63" x2="6.38" y1="11" y2="11" style="stroke:#fff;"></line>
              </svg>
            </button>
            <a id="customLinkButton" class="btn btn-dark rounded-0 btn-sm btn-customlink">Campus</a>
            <div class="dropdown ql-picker">
              <a class="btn btn-sm text-dark rounded-0 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Paràmetres</a>
              <ul class="dropdown-menu shadow-sm">
                <li><a class="dropdown-item small text-dark" href="#" data-text="[TERCERSNOMBRESINAPELLIDOS]">TERCERSNOMBRESINAPELLIDOS</a></li>
                <li><a class="dropdown-item small text-dark" href="#" data-text="[PARAMETROUNODEST]">PARAMETROUNODEST</a></li>
                <li><a class="dropdown-item small text-dark" href="#" data-text="[PARAMETRODOSDEST]">PARAMETRODOSDEST</a></li>
                <li><a class="dropdown-item small text-dark" href="#" data-text="[PARAMETROTRESDEST]">PARAMETROTRESDEST</a></li>
              </ul>
            </div>
          </div>
          <!-- Campus Link Modal -->
          <div id="urlModal" class="modal">
            <div class="modal-content rounded-0 border font-monospace">
              <span class="close-button">&times;</span>
              <input class="form-control border rounded-0" type="text" id="urlInput" placeholder="https://">
              <div class="autocomplete-list" id="autocompleteList"></div>
              <div class="form-check">
                <input class="form-check-input border" type="checkbox" id="prependCheckbox"> 
                <label class="form-check-label" for="prependCheckbox">Login CAS</label>
              </div>
              <div class="form-check">
                <input class="form-check-input border" type="checkbox" id="secondPrependCheckbox">
                <label class="form-check-label" for="secondPrependCheckbox">Capçalera UOC</label>
              </div>
              <button id="insertLinkBtn" class="btn btn-dark font-monospace btn-sm mt-3 rounded-0">Inserir link</button>
            </div>
          </div>
          <!-- Custom Code Modal -->
          <div id="codeModal" class="modal">
            <div class="modal-content rounded-0 border font-monospace">
              <span class="close-button" id="codeCloseButton">&times;</span>
              <input class="form-control border rounded-0 mb-2" type="text" id="codeTextInput" placeholder="Literal del botó">
              <input class="form-control border rounded-0 mb-2" type="text" id="codeUrlInput" placeholder="Enllaç">
              <div class="autocomplete-list" id="codeAutocompleteList"></div>
              <div class="form-check">
                <input class="form-check-input border" type="checkbox" id="codePrependCheckbox"> 
                <label class="form-check-label" for="codePrependCheckbox">Login CAS</label>
              </div>
              <div class="form-check">
                <input class="form-check-input border" type="checkbox" id="codeSecondPrependCheckbox">
                <label class="form-check-label" for="codeSecondPrependCheckbox">Capçalera UOC</label>
              </div>
              <button id="insertCodeBtn" class="btn btn-dark font-monospace btn-sm mt-3 rounded-0">Inserir botó</button>
            </div>
          </div>
          <div id="editor" class="bg-white border p-2" spellcheck="false"></div>
        </div>
        <!-- New Analytics Snippet Fields added below the Quill editor -->
        <div id="row-snippet" class="form-group p-2 mt-2 font-monospace bg-white border">
          <label class="form-label fw-bold">Marcatge Analytics</label>
          <div class="col-12">
            <div class="row">
              <div class="col">
                <input id="fill-placom" type="text" class="form-control rounded-0 p-1 border font-monospace" placeholder="Placom" autocomplete="off">
              </div>
              <div class="col">
                <input id="fill-collectiu" type="text" class="form-control rounded-0 p-1 border font-monospace" placeholder="Col·lectiu" autocomplete="off">
              </div>
              <div class="col">
                <input id="fill-identificatiu" type="text" class="form-control rounded-0 p-1 border font-monospace" placeholder="Text" autocomplete="off">
              </div>
              <div class="col">
                <input id="fill-date" type="text" class="form-control rounded-0 p-1 border font-monospace" placeholder="Data" autocomplete="off">
              </div>
              <div class="col">
                <input id="fill-campaign" type="text" class="form-control rounded-0 p-1 border font-monospace" placeholder="Campaign" autocomplete="off">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <!-- HTML output area -->
        <label for="htmlOutput" class="form-label fw-bold font-monospace">HTML</label>
        <textarea id="htmlOutput" class="font-monospace p-2 border rounded-0" placeholder="Sortida HTML editable..." spellcheck="false"></textarea>
        <div class="px-2 pt-2 mt-2 font-monospace bg-white border">
          <label class="form-label fw-bold">Bústia:</label>
          <div id="serviceSelection" class="form-check form-check-inline">
            <div class="form-check form-check-inline">
              <input class="form-check-input border" type="radio" name="service" value="informacio" checked>
              <label class="form-check-label">Servei d'informació</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input border" type="radio" name="service" value="pdc">
              <label class="form-check-label">Suport Docència</label>
            </div>
          </div><br>
          <label class="form-label fw-bold">Idioma:</label>
          <div id="languageSelection" class="form-check form-check-inline">
            <div class="form-check form-check-inline">
              <input class="form-check-input border" type="radio" name="language" value="ca" checked>
              <label class="form-check-label">Català</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input border" type="radio" name="language" value="es">
              <label class="form-check-label">Espanyol</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input border" type="radio" name="language" value="en">
              <label class="form-check-label">Anglès</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input border" type="radio" name="language" value="no">
              <label class="form-check-label">Cap</label>
            </div>
          </div>
        </div>
        <button id="copyCodeBtn" class="btn btn-dark font-monospace btn-sm mt-3 rounded-0 px-2">Copia HTML</button>
        <button id="previewButton" class="btn btn-dark font-monospace btn-sm mt-3 rounded-0 px-2">Vista prèvia</button>
        <button onclick="location.reload(true);" class="btn btn-dark font-monospace btn-sm mt-3 rounded-0 px-2">Neteja</button>
      </div>
    </div>
    <div class="row mt-5 mb-3">
      <div id="preview"></div>
    </div>
  </div>
  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Override Quill's default Link format
      const Link = Quill.import('formats/link');
      const oldCreate = Link.create;
      Link.create = function(value) {
        let node = oldCreate.call(this, value);
        node.setAttribute('target', '_blank');
        node.style.textDecoration = 'underline';
        node.style.color = '#000078';
        return node;
      };
      Quill.register(Link, true);

      let customCodeSnippets = {};
      let customCodeCounter = 0;
      let youtubeSnippets = {};
      let youtubeCounter = 0;
      let codeSavedRange = null;
      let savedRange = null;

      // Custom embed blot for code snippet
      const BlockEmbed = Quill.import('blots/block/embed');
      class CustomSnippetBlot extends BlockEmbed {
        static create(value) {
          let node = super.create();
          node.setAttribute('data-marker', value.marker);
          node.classList.add('placeholder-boto');
          node.innerText = value.displayText;
          return node;
        }
        static value(node) {
          return {
            marker: node.getAttribute('data-marker'),
            displayText: node.innerText
          };
        }
      }
      CustomSnippetBlot.blotName = 'customSnippet';
      CustomSnippetBlot.tagName = 'div';
      Quill.register(CustomSnippetBlot);

      // Custom embed blot for youtube snippet
      class YouTubeSnippetBlot extends BlockEmbed {
        static create(value) {
          let node = super.create();
          node.setAttribute('data-marker', value.marker);
          node.classList.add('placeholder-youtube');
          node.innerText = value.displayText;
          return node;
        }
        static value(node) {
          return {
            marker: node.getAttribute('data-marker'),
            displayText: node.innerText
          };
        }
      }
      YouTubeSnippetBlot.blotName = 'youtubeSnippet';
      YouTubeSnippetBlot.tagName = 'div';
      Quill.register(YouTubeSnippetBlot);

      // Initialize Quill
      const quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: '#toolbar' }
      });

      // Parameter insertion from dropdown
      document.querySelectorAll('.dropdown-item[data-text]').forEach(item => {
        item.addEventListener('click', event => {
          event.preventDefault();
          const textToInsert = item.getAttribute('data-text');
          const range = quill.getSelection(true);
          quill.insertText(range.index, textToInsert);
          quill.setSelection(range.index + textToInsert.length);
        });
      });

      // Insert image via URL
      document.querySelector('.ql-image-url').addEventListener('click', () => {
        const url = prompt('URL imatge:');
        if (url) {
          const range = quill.getSelection();
          quill.insertEmbed(range.index, 'image', url);
        }
      });

      // Override Quill's default Image format so each inserted image has max-width:100%
      const Image = Quill.import('formats/image');
      const originalCreate = Image.create;
      Image.create = function(value) {
        const node = originalCreate.call(this, value);
        node.style.maxWidth = '100%';
        return node;
      };
      Quill.register(Image, true);

      // Add a click listener on the Quill editor’s root element
      quill.root.addEventListener('click', (event) => {
        if (event.target && event.target.tagName === 'IMG') {
          // Find the Quill blot that corresponds to the clicked image
          const blot = Quill.find(event.target);
          if (!blot) return;
          // Get the blot's offset in the editor, then select it
          const index = blot.offset(quill.scroll);
          quill.setSelection(index, 1, Quill.sources.USER);
        }
      });

      // Beautify
      function beautifyEditorContent(html) {
        return html.replace(/>\s*<(?!\/)(?!(?:a|em|i|b|strong|br)\b)/g, '>\n<');
      }

      // Service text helper
      function getServiceText(lang) {
        const service = document.querySelector('input[name="service"]:checked')?.value || 'informacio';
        if (lang === 'ca') {
          return service === 'informacio' ? "del Servei d'informació" : "de Suport Docència";
        } else if (lang === 'es') {
          return service === 'informacio' ? "del Servicio de información" : "de Apoyo Docente";
        } else if (lang === 'en') {
          return service === 'informacio' ? "Information Service" : "Teaching Support";
        } else {
          return "";
        }
      }

      // Update HTML output
      function updateHtmlOutput(title, lang) {
        // Save scroll/cursor in CodeMirror so it won't jump to top
        const scrollInfo = htmlEditor.getScrollInfo();
        const cursor = htmlEditor.getCursor();

        let editorContent = quill.root.innerHTML;
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = editorContent;

        // Replace placeholders
        tempContainer.querySelectorAll('.placeholder-boto').forEach(el => {
          const marker = el.getAttribute('data-marker');
          const snippet = customCodeSnippets[marker];
          if (snippet) {
            el.outerHTML = snippet;
          }
        });
        tempContainer.querySelectorAll('.placeholder-youtube').forEach(el => {
          const marker = el.getAttribute('data-marker');
          const snippet = youtubeSnippets[marker];
          if (snippet) {
            el.outerHTML = snippet;
          }
        });

        const beautifiedContent = beautifyEditorContent(tempContainer.innerHTML);
        const serviceText = getServiceText(lang);
        const languageSnippets = {
          ca: `La bústia ${serviceText} és només emissora de missatges. En el cas que tinguis qualsevol dubte, tens a la teva disposició el <em>Servei d'atenció</em> del Campus Virtual.<br>En aquests moments, reps les comunicacions en català. Si vols, pots canviar-ho en qualsevol moment des del teu <em><a style="color: #000078; text-decoration: underline;" href="https://campus.uoc.edu/webapps/cas/login?service=https://campus.uoc.edu/UOC/a/varis/miss_informacio/js/FinestraCampus.html%3Fhtm=https://campus.uoc.edu/estudiant/espai-personal/ca/index.html" target="_blank">Espai personal / Informació personal / Canvi d'idioma dels missatges</a></em>.`,
          es: `El buzón ${serviceText} es solo emisor de mensajes. Si tienes cualquier duda, el <em>Servicio de atención</em> del Campus Virtual está a tu disposición.<br>En estos moments recibes las comunicaciones en español. Si quieres, puedes cambiarlo en cualquier momento desde tu <em><a style="color: #000078; text-decoration: underline;" href="https://campus.uoc.edu/webapps/cas/login?service=https://campus.uoc.edu/UOC/a/varis/miss_informacio/js/FinestraCampus.html%3Fhtm=https://campus.uoc.edu/estudiant/espai-personal/es/index.html" target="_blank">Espacio personal / Información personal / Cambio de idioma de los mensajes</a></em>.`,
          en: `The ${serviceText} email address is used only to send out messages. Should you have any doubts, please consult the Help Service on the Virtual Campus.<br>You are currently receiving messages in English. You can change this whenever you want in your <em><a style="color: #000078; text-decoration: underline;" href="https://campus.uoc.edu/webapps/cas/login?service=https://campus.uoc.edu/UOC/a/varis/miss_informacio/js/FinestraCampus.html%3Fhtm=https://campus.uoc.edu/estudiant/espai-personal/en/index.html" target="_blank">Personal area / Personal information / Change the language for messages</a></em> section.`,
          no: ``
        };

        // Build the analytics snippet from the new fields:
        var placom = document.getElementById("fill-placom") ? document.getElementById("fill-placom").value.trim() : "";
        var collectiu = document.getElementById("fill-collectiu") ? document.getElementById("fill-collectiu").value.trim() : "";
        var identificatiu = document.getElementById("fill-identificatiu") ? document.getElementById("fill-identificatiu").value.trim() : "";
        var dateVal = document.getElementById("fill-date") ? document.getElementById("fill-date").value.trim() : "";
        var campaign = document.getElementById("fill-campaign") ? document.getElementById("fill-campaign").value.trim() : "";
        var analyticsOutput = "";
        if (placom || collectiu || identificatiu || dateVal) {
          var pathStr = "/email" +
              (placom ? "/" + placom : "") +
              (collectiu ? "/" + collectiu : "") +
              (identificatiu ? "/" + identificatiu : "") +
              (dateVal ? "/" + dateVal : "") +
              ".html";
          analyticsOutput = '<img src="https://queue.simpleanalyticscdn.com/noscript.gif?timezone=Europe%2FAmsterdam&unique=false' +
              '&hostname=cv.uoc.edu&path=' + encodeURI(pathStr) +
              (campaign ? '&utm_campaign=' + campaign : '') +
              '&utm_content=[OBTENERPARAMETROUNODEST]&utm_medium=notificador&https=true" ' +
              'referrerpolicy="no-referrer-when-downgrade" alt="" />';
        }

        if (lang === 'no') {
          htmlEditor.setValue(beautifiedContent);
        } else {
          htmlEditor.setValue(getFinalHtmlTemplate(title, lang, beautifiedContent, languageSnippets, analyticsOutput));
        }

        // Restore scroll and cursor
        htmlEditor.scrollTo(scrollInfo.left, scrollInfo.top);
        htmlEditor.setCursor(cursor);
      }

      function getSelectedLanguage() {
        return document.querySelector('input[name="language"]:checked')?.value || 'ca';
      }

      const titleInput = document.getElementById('titleInput');
      const htmlOutput = document.getElementById('htmlOutput');

      // Initialize CodeMirror
      const htmlEditor = CodeMirror.fromTextArea(htmlOutput, {
        mode: "htmlmixed",
        theme: "dracula",
        lineNumbers: true,
        readOnly: false,
        lineWrapping: true,
        smartIndent: false
      });
      htmlEditor.setSize("100%", "525px");

      // Listen to Quill changes
      quill.on('text-change', () => {
        updateHtmlOutput(titleInput.value, getSelectedLanguage());
      });

      // Automatically update analytics snippet when analytics input fields change
      $(function() {
        $('#fill-placom, #fill-collectiu, #fill-identificatiu, #fill-date, #fill-campaign').on('input change', function() {
          updateHtmlOutput(titleInput.value, getSelectedLanguage());
        });
      });

      // Handle file input
      document.getElementById('fileInput').addEventListener('change', (event) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          mammoth.convertToHtml({ arrayBuffer: e.target.result })
            .then(result => {
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = result.value;

              // Basic style tweaks
              tempDiv.querySelectorAll('a').forEach(link => {
                link.setAttribute('target', '_blank');
                link.style.color = '#000078';
                link.style.textDecoration = 'underline';
              });
              tempDiv.querySelectorAll('ul, ol').forEach(list => {
                list.style.cssText = 'padding-left:15px; line-height:150%;';
              });
              tempDiv.querySelectorAll('h1, h2').forEach(header => {
                if (header.tagName.toLowerCase() === 'h1') {
                  header.style.cssText = 'font-size:28px; line-height:26px;';
                } else if (header.tagName.toLowerCase() === 'h2') {
                  header.style.cssText = 'font-size:26px; line-height:26px;';
                }
              });

              // Put the result into Quill
              quill.root.innerHTML = tempDiv.innerHTML;
              updateHtmlOutput(titleInput.value, 'ca');
            })
            .catch(console.error);
        };
        reader.readAsArrayBuffer(event.target.files[0]);
      });

      // Title changes
      titleInput.addEventListener('input', () => {
        updateHtmlOutput(titleInput.value, getSelectedLanguage());
      });

      // Copy code
      document.getElementById('copyCodeBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(htmlEditor.getValue());
      });

      // Link modal
      const urlModal = document.getElementById('urlModal');
      const urlInput = document.getElementById('urlInput');
      const autocompleteList = document.getElementById('autocompleteList');

      document.getElementById('customLinkButton').addEventListener('click', () => {
        const range = quill.getSelection();
        if (range) {
          savedRange = range;
          urlModal.style.display = 'block';
        } else {
          alert('Selecciona el text a enllaçar.');
        }
      });

      document.querySelector('.close-button').addEventListener('click', () => {
        urlModal.style.display = 'none';
        restoreSelection();
      });

      window.addEventListener('click', (event) => {
        if (event.target === urlModal) {
          urlModal.style.display = 'none';
          restoreSelection();
        }
      });

      function restoreSelection() {
        if (savedRange) {
          quill.setSelection(savedRange.index, savedRange.length);
          savedRange = null;
        }
      }

      urlInput.addEventListener('input', () => {
        const query = urlInput.value.toLowerCase();
        autocompleteList.innerHTML = '';
        if (query) {
          urls.filter(url => url.toLowerCase().includes(query))
              .forEach(url => {
                const item = document.createElement('div');
                item.textContent = url;
                item.classList.add('autocomplete-item');
                item.onclick = () => {
                  urlInput.value = url;
                  autocompleteList.innerHTML = '';
                };
                autocompleteList.appendChild(item);
              });
        }
      });

      document.getElementById('insertLinkBtn').addEventListener('click', () => {
        let urlInputValue = urlInput.value.trim();
        const prepend = document.getElementById('prependCheckbox').checked
          ? 'https://campus.uoc.edu/webapps/cas/login?service='
          : '';
        const secondPrepend = document.getElementById('secondPrependCheckbox').checked
          ? 'https://campus.uoc.edu/UOC/a/varis/miss_informacio/js/FinestraCampus.html%3Fhtm='
          : '';
        let fullUrl = prepend + secondPrepend + urlInputValue;
        if (!/^https?:\/\//i.test(fullUrl)) {
          fullUrl = 'https://' + fullUrl;
        }
        if (savedRange && fullUrl) {
          const linkText = quill.getText(savedRange.index, savedRange.length) || "Link";
          quill.deleteText(savedRange.index, savedRange.length);
          quill.insertText(savedRange.index, linkText, 'link', fullUrl);
          quill.setSelection(savedRange.index + linkText.length);
        }
        urlModal.style.display = 'none';
      });

      // Custom code modal
      const codeModal = document.getElementById('codeModal');
      const codeTextInput = document.getElementById('codeTextInput');
      const codeUrlInput = document.getElementById('codeUrlInput');
      const codeCloseButton = document.getElementById('codeCloseButton');
      const insertCodeBtn = document.getElementById('insertCodeBtn');

      document.getElementById('customCodeButton').addEventListener('click', () => {
        const range = quill.getSelection();
        if (range) {
          codeSavedRange = range;
          codeModal.style.display = 'block';
        } else {
          alert('Selecciona el lloc on inserir el botó.');
        }
      });

      codeCloseButton.addEventListener('click', () => {
        codeModal.style.display = 'none';
        restoreCodeSelection();
      });

      window.addEventListener('click', (event) => {
        if (event.target === codeModal) {
          codeModal.style.display = 'none';
          restoreCodeSelection();
        }
      });

      function restoreCodeSelection() {
        if (codeSavedRange) {
          quill.setSelection(codeSavedRange.index, codeSavedRange.length);
          codeSavedRange = null;
        }
      }

      codeUrlInput.addEventListener('input', () => {
        const query = codeUrlInput.value.toLowerCase();
        const codeAutocompleteList = document.getElementById('codeAutocompleteList');
        codeAutocompleteList.innerHTML = '';
        if (query) {
          urls.filter(url => url.toLowerCase().includes(query))
              .forEach(url => {
                const item = document.createElement('div');
                item.textContent = url;
                item.classList.add('autocomplete-item');
                item.onclick = () => {
                  codeUrlInput.value = url;
                  codeAutocompleteList.innerHTML = '';
                };
                codeAutocompleteList.appendChild(item);
              });
        }
      });

      insertCodeBtn.addEventListener('click', () => {
        const textValue = codeTextInput.value.trim();
        const urlValue = codeUrlInput.value.trim();
        if (!textValue || !urlValue) {
          alert('Si us plau, omple ambdós camps.');
          return;
        }
        const codePrepend = document.getElementById('codePrependCheckbox').checked
          ? 'https://campus.uoc.edu/webapps/cas/login?service='
          : '';
        const codeSecondPrepend = document.getElementById('codeSecondPrependCheckbox').checked
          ? 'https://campus.uoc.edu/UOC/a/varis/miss_informacio/js/FinestraCampus.html%3Fhtm='
          : '';
        let fullUrl = codePrepend + codeSecondPrepend + urlValue;
        if (!/^https?:\/\//i.test(fullUrl)) {
          fullUrl = 'https://' + fullUrl;
        }
        const snippet = `<a href="${fullUrl}" target="_blank" style="text-decoration:none;color:#ffffff">
  <table width="300" border="0" cellspacing="0" cellpadding="4" height="40">
    <tbody><tr>
      <td align="center" valign="middle" style="background-color:#000078;color:#ffffff">${textValue}</td>
    </tr></tbody>
  </table>
</a>`;
        customCodeCounter++;
        const marker = "CUSTOM_CODE_" + customCodeCounter;
        customCodeSnippets[marker] = snippet;
        if (codeSavedRange) {
          quill.deleteText(codeSavedRange.index, codeSavedRange.length);
          quill.insertEmbed(codeSavedRange.index, 'customSnippet', { marker: marker, displayText: textValue });
          quill.setSelection(codeSavedRange.index + 1);
        }
        codeModal.style.display = 'none';
      });

      // YouTube snippet
      document.getElementById('youtubeButton').addEventListener('click', () => {
        let youtubeCode = prompt("Introdueix només el codi de YouTube:");
        if (!youtubeCode) return;
        youtubeCounter++;
        const marker = "YOUTUBE_CODE_" + youtubeCounter;
        const snippet = `<div id="cos" name="cos" style="padding:0;position:relative;background:url(http://img.youtube.com/vi/${youtubeCode}/0.jpg) no-repeat center;background-size:cover;width:540px;height:280px">
          <div style="background-color:#000078;height:280px;opacity:.6">
            <a href="http://www.youtube.com/watch?v=${youtubeCode}" target="_blank"><img id="imatge_video" name="imatge_video" src="http://cv.uoc.edu/estudiant/_resources/img/novetats/butlleti/ico-video-blanco-thumb.png" border="0" style="margin-top:110px;margin-left:235px" /></a>
          </div>
        </div>
        <iframe width="540" height="280" frameborder="0" title="Video" id="video-principal" name="video-principal" src="https://www.youtube.com/embed/${youtubeCode}" allowfullscreen style="display:none"></iframe>`;
        youtubeSnippets[marker] = snippet;
        const range = quill.getSelection();
        if (range) {
          quill.insertEmbed(range.index, 'youtubeSnippet', { marker: marker, displayText: youtubeCode });
          quill.setSelection(range.index + 1);
        }
      });

      // Service & language changes
      document.querySelectorAll('input[name="service"]').forEach(radio => {
        radio.addEventListener('change', () => {
          updateHtmlOutput(titleInput.value, getSelectedLanguage());
        });
      });
      document.querySelectorAll('input[name="language"]').forEach(radio => {
        radio.addEventListener('change', function () {
          updateHtmlOutput(titleInput.value, this.value);
        });
      });

      // Preview
      document.getElementById('previewButton').addEventListener('click', () => {
        const htmlContent = htmlEditor.getValue();
        const preview = document.getElementById('preview');
        preview.innerHTML = htmlContent;
        preview.classList.add('px-2', 'py-3', 'bg-white', 'border');
      });
    });

    // Initialize jQuery UI Autocomplete for the analytics snippet fields
    $(function() {
      var placomList = [
        "_ad_",
        "_butlletins_actualitat_",
        "_CANVAS_",
        "_lms_",
        "_ocupabilitat_",
        "_fira_ocupabilitat_",
        "_FP_PS_",
        "_graduacio_",
        "_PAF_",
        "_plans_",
        "_eleccions_"
      ];
      $("#fill-placom").autocomplete({
  source: placomList,
  minLength: 0,
  select: function(event, ui) {
    $(this).val(ui.item.value).trigger("change");
  }
}).focus(function() {
  $(this).autocomplete("search", "");
});

      
      var collectiuList = ["estudiant", "pdc", "pra", "tutor"];
      $("#fill-collectiu").autocomplete({
        source: collectiuList,
        minLength: 0,
        select: function(event, ui) {
    $(this).val(ui.item.value).trigger("change");
  }
}).focus(function() {
  $(this).autocomplete("search", "");
});
      
      var campaigns = ["povspaf", "butlletins_actualitat", "butlletiacollida", "lms"];
      $("#fill-campaign").autocomplete({
        source: campaigns,
        minLength: 0,
        select: function(event, ui) {
    $(this).val(ui.item.value).trigger("change");
  }
}).focus(function() {
  $(this).autocomplete("search", "");
});

      // Pre-fill the date field with the current date in YYYYMMDD format
      const today = new Date();
      const yyyy = today.getFullYear().toString();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('fill-date').value = yyyy + mm + dd;
    });
  </script>
</body>
</html>
